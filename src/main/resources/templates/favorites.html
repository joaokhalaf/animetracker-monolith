<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Favorites - AnimeTracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="bg-gray-100">
    <nav class="bg-gray-800 text-white">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-3">
                <a class="text-xl font-bold" href="/">AnimeTracker</a>
                <button class="md:hidden navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="hidden md:flex md:items-center" id="navbarNav">
                    <ul class="flex flex-col md:flex-row md:ml-auto md:space-x-4">
                        <li><a class="block py-2 px-3 rounded hover:bg-gray-700" href="/"><i class="bi bi-house-door"></i> Home</a></li>
                        <li sec:authorize="isAuthenticated()"><a class="block py-2 px-3 rounded bg-gray-900 font-bold" th:href="@{/favorites}"><i class="bi bi-heart"></i> My Favorites</a></li>
                        <li sec:authorize="isAuthenticated()"><a class="block py-2 px-3 rounded hover:bg-gray-700" th:href="@{/favorite-lists}"><i class="bi bi-list-stars"></i> My Lists</a></li>
                        </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-5">
        <h1 class="text-3xl font-bold mb-4">My Favorite Anime</h1>

        <div class="bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative mb-4" th:if="${animeList.isEmpty()}">
            <p class="mb-0">You haven't added any favorites yet. <a href="/" class="font-bold text-blue-800 hover:underline">Search for anime</a> to add to your favorites!</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="col" th:each="anime : ${animeList}"> <div class="bg-white rounded-lg shadow-lg overflow-hidden h-full flex flex-col anime-card">
                    <img th:src="${anime.imageUrl}" class="w-full h-48 object-cover anime-image" th:alt="${anime.title}"
                         onerror="this.src='/images/no-image.jpg';">

                    <div class="p-4 flex flex-col flex-grow">
                        <h5 class="text-xl font-bold mb-1" th:text="${anime.title}">Anime Title</h5>

                        <div class="mb-3">
                            <small class="text-gray-500 text-sm" th:text="${anime.genres}">Genres</small>
                        </div>

                        <p class="text-gray-700 text-sm mb-4 flex-grow synopsis" th:text="${#strings.abbreviate(anime.synopsis, 200)}">Synopsis</p>

                        <div class="flex justify-between items-center">
                            <a th:href="${anime.urlMal}" target="_blank" class="text-sm border border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white font-bold py-1 px-2 rounded">
                                View on MAL
                            </a>

                            <button class="text-sm bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded favorite-btn"
                                    th:data-anime-id="${anime.id}"
                                    onclick="removeFavorite(this)">
                                <i class="bi bi-heart-fill"></i>
                                Remove
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white text-center py-4 mt-5">
        <div class="container mx-auto px-4">
            <p class="mb-0">Â© 2025 AnimeTracker - Find your perfect anime database</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function removeFavorite(button) {
            const animeId = button.getAttribute('data-anime-id');
            const card = button.closest('.col');

            fetch(`/api/favorites/remove?animeId=${animeId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    card.style.transition = 'opacity 0.5s ease';
                    card.style.opacity = '0';
                    setTimeout(() => {
                        card.remove();

                        const remainingCards = document.querySelectorAll('.anime-card');
                        if (remainingCards.length === 0) {
                            const container = document.querySelector('.container');
                            const heading = document.querySelector('h1');

                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-info mb-4';
                            alertDiv.innerHTML = '<p class="mb-0">You haven\'t added any favorites yet. <a href="/" class="alert-link">Search for anime</a> to add to your favorites!</p>';

                            container.insertBefore(alertDiv, heading.nextSibling);
                        }
                    }, 500);
                } else {
                    console.error('Error:', data.message);
                    alert('There was an error removing the anime from favorites.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error removing the anime from favorites.');
            });
        }
    </script>
</body>
</html>
